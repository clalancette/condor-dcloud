
Summary:        @CPACK_RPM_PACKAGE_SUMMARY@
Name:           @CPACK_RPM_PACKAGE_NAME@
Version:        @CPACK_RPM_PACKAGE_VERSION@
Release:        @CPACK_RPM_PACKAGE_RELEASE@
License:        @CPACK_RPM_PACKAGE_LICENSE@
Group:          @CPACK_RPM_PACKAGE_GROUP@
Vendor:         @CPACK_RPM_PACKAGE_VENDOR@
URL:		@CPACK_RPM_PACKAGE_URL@

Requires(pre): shadow-utils
Requires(post):/sbin/chkconfig
Requires(preun):/sbin/chkconfig
Requires(preun):/sbin/service
Requires(postun):/sbin/service

#Do not reorder these prefixes
Prefix: /etc
Prefix: /usr
Prefix: /var

Buildroot:      @CPACK_RPM_DIRECTORY@/@CPACK_PACKAGE_FILE_NAME@
%define _rpmdir @CPACK_RPM_DIRECTORY@
%define _rpmfilename @CPACK_RPM_FILE_NAME@
%define _unpackaged_files_terminate_build 0
%define _topdir @CPACK_RPM_DIRECTORY@

%description
@CPACK_RPM_PACKAGE_DESCRIPTION@


%files

#/var (_var/ = /var)
%defattr(-,condor,condor,-)
%dir %_var/lib/condor/
%dir %_var/lib/condor/execute/
%dir %_var/lib/condor/spool/
%dir %_var/log/condor/
%dir %_var/lock/condor/
%dir %_var/run/condor/

%defattr(-,root,root,-)
%dir %_sysconfdir/condor/
%config(noreplace) %_sysconfdir/condor/condor_config
%config(noreplace) %_sysconfdir/condor/condor_config.local

#Init script
%_sysconfdir/init.d/condor

%defattr(-,root,root,-)

#/usr/include/condor (_includedir/ = /usr/include)
%dir %_includedir/condor

#/usr/lib/condor (_libdir/ = /usr/lib | /usr/lib64)
%dir %_libdir/condor

#/usr/libexec/condor (_libexecdir/ = /usr/libexec)
%dir %_libexecdir/condor

#/usr/man/man1 (_mandir/ = /usr/man)
#%_mandir

#/usr/share/condor (_datadir/ = /usr/share)
#%_datadir/condor

#Documentation (/usr/share/doc/%{name}-%{version})
%dir %_datadir/doc/%{name}-%{version}

#/usr/src/ (_usrsrc/ = /usr/src)
#%_usrsrc/chirp/*
#%_usrsrc/drmaa/*
#%_usrsrc/startd_factory

#Binaries
#%_usr/bin
#/usr/sbin (_sbindir/ = /usr/sbin)
#%_sbindir 
@CPACK_RPM_INSTALL_FILES@




%pre
#Add condor group if not existed
getent group condor >/dev/null || groupadd -r condor

#Add condor user if not existed
getent passwd condor >/dev/null || \
  useradd -r -g condor -d %_var/lib/condor -s /sbin/nologin \
    -c "Owner of Condor Daemons" condor

if [ "$1" -ge "2" ]; then
  #Stopping condor if there is existing version
  /sbin/service condor stop >/dev/null 2>&1 || :
fi

exit 0

%post -n condor

#Get relocated prefix
ETC=$RPM_INSTALL_PREFIX0
USR=$RPM_INSTALL_PREFIX1
VAR=$RPM_INSTALL_PREFIX2

#Patch config file if relocated

if [ $USR != "/usr" ] ; then
  perl -p -i -e "s:^CONDOR_CONFIG_VAL=.*:CONDOR_CONFIG_VAL=$USR/bin/condor_config_val:" $ETC/init.d/condor 
  perl -p -i -e "s:^RELEASE_DIR(\s*)=.*:RELEASE_DIR\$1= $USR:" $ETC/condor/condor_config   
fi

if [ $VAR != "/var" ] ; then
  perl -p -i -e "s:^LOCAL_DIR(\s*)=.*:LOCAL_DIR\$1= $VAR:" $ETC/condor/condor_config   
fi

if [ $ETC != "/etc" ] ; then
  perl -p -i -e "s:^CONDOR_CONFIG=.*:CONDOR_CONFIG=$ETC/condor/condor_config:" $ETC/init.d/condor 
  perl -p -i -e "s:^LOCAL_CONFIG_FILE(\s*)=\s*/etc(.*):LOCAL_CONFIG_FILE\$1= $ETC\$2:" $ETC/condor/condor_config 
  
  #Install init.d script
  cp -f $ETC/init.d/condor /etc/init.d/condor  
fi


#Add condor service
/sbin/chkconfig --add condor
/sbin/ldconfig
test -x /usr/sbin/selinuxenabled && /usr/sbin/selinuxenabled
if [ $? = 0 ]; then
   semanage fcontext -a -t unconfined_execmem_exec_t $USR/sbin/condor_startd 2>&1| grep -v "already defined"
   restorecon  $USR/sbin/condor_startd
fi
exit 0


%preun -n condor

#Stop condor
/sbin/service condor stop >/dev/null 2>&1 || :
if [ $1 = 0 ]; then
  
  /sbin/chkconfig --del condor
  
  #Remove init.d if relocated
  ETC=$RPM_INSTALL_PREFIX0
  if [ $ETC != "/etc" ] ; then    
    rm /etc/init.d/condor
  fi

fi


%postun -n condor
#if [ "$1" -ge "1" ]; then
  #Upgrading or remove but other version existed 
  #/sbin/service condor restart >/dev/null 2>&1 || :
#fi
/sbin/ldconfig


%changelog
* @CPACK_RPM_DATE@  <condor-users@cs.wisc.edu> - @CPACK_RPM_PACKAGE_VERSION@-@CPACK_RPM_PACKAGE_RELEASE@
- Please see version history at http://www.cs.wisc.edu/condor/manual/v@CPACK_RPM_PACKAGE_VERSION@/8_Version_History.html

* Sun Jan 24 2010  <kooburat@cs.wisc.edu> - 7.5.0-2
- Make RPM relocatable and support multiple version install

* Fri Nov 13 2009  <kooburat@cs.wisc.edu> - 7.4.0-1
- Initial release based on Fedora's RPM by <matt@redhat>

